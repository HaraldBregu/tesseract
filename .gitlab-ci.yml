default:
  timeout: 1h # Timeout di default per tutti i job

# Cache configuration for faster builds (Yarn 4 with PnP)
cache:
  key:
    files:
      - yarn.lock
  paths:
    - .yarn/cache/
    - .pnp.cjs
    - .pnp.loader.mjs
    - node_modules/

stages:
  - Build-Check
  - Build-Windows
  - Build-Linux
  #- Build-macOS

# ============================================================================
# BUILD CHECK STAGE
# ============================================================================

# Lint the code - Development (develop branch)
lint:dev:
  stage: Build-Check
  image: electronuserland/builder:wine
  timeout: 4h
  variables:
    NODE_ENV: development
  script:
    - corepack enable
    - corepack prepare yarn@4.11.0 --activate
    - apt-get update && apt-get install -y build-essential libxtst-dev libpng++-dev gcc g++ make libpixman-1-dev libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
    - node --version
    - yarn --version
    - yarn install
    - echo "Dependencies installed successfully"
    - echo "Running typecheck:node..."
    - yarn typecheck:node
    - echo "Node typecheck passed"
    - echo "Running typecheck:web..."
    - yarn typecheck:web
    - echo "Web typecheck passed"
  only:
    - develop
  tags:
    - docker

# Lint the code - Staging (pre branch)
lint:staging:
  stage: Build-Check
  image: electronuserland/builder:wine
  timeout: 4h
  variables:
    NODE_ENV: staging
  script:
    - corepack enable
    - corepack prepare yarn@4.11.0 --activate
    - apt-get update && apt-get install -y build-essential libxtst-dev libpng++-dev gcc g++ make libpixman-1-dev libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
    - node --version
    - yarn --version
    - yarn install
    - echo "Dependencies installed successfully"
    - echo "Running typecheck:node..."
    - yarn typecheck:node
    - echo "Node typecheck passed"
    - echo "Running typecheck:web..."
    - yarn typecheck:web
    - echo "Web typecheck passed"
  only:
    - pre
  tags:
    - docker

# Lint the code - Production (prod branch)
lint:prod:
  stage: Build-Check
  image: electronuserland/builder:wine
  timeout: 4h
  variables:
    NODE_ENV: production
  script:
    - corepack enable
    - corepack prepare yarn@4.11.0 --activate
    - apt-get update && apt-get install -y build-essential libxtst-dev libpng++-dev gcc g++ make libpixman-1-dev libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
    - node --version
    - yarn --version
    - yarn install
    - echo "Dependencies installed successfully"
    - echo "Running typecheck:node..."
    - yarn typecheck:node
    - echo "Node typecheck passed"
    - echo "Running typecheck:web..."
    - yarn typecheck:web
    - echo "Web typecheck passed"
  only:
    - prod
  tags:
    - docker

sonarqube-check:
  stage: Build-Check
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
    SONAR_HOST_URL: "${SONAR_HOST_URL}"
    SONAR_TOKEN: "${SONAR_TOKEN}"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner -Dsonar.token=${SONAR_TOKEN}
  allow_failure: true
  only:
    - prod
  tags:
    - docker

# ============================================================================
# WINDOWS BUILD STAGE
# ============================================================================

# Windows build template
.build-windows-template: &build-windows-template
  stage: Build-Windows
  image: electronuserland/builder:wine
  timeout: 4h
  script:
    - corepack enable
    - corepack prepare yarn@4.11.0 --activate
    - apt-get update && apt-get install -y mono-complete build-essential libxtst-dev libpng++-dev gcc g++ make libpixman-1-dev libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
    - apt-get install -y winbind xvfb
    - Xvfb :0 -screen 0 1024x768x24 &
    - export DISPLAY=:0
    - sleep 2
    - wget https://dl.winehq.org/wine/wine-mono/9.0.0/wine-mono-9.0.0-x86.msi -O /tmp/wine-mono.msi
    - wine msiexec /i /tmp/wine-mono.msi /quiet /norestart || true
    - wget https://github.com/wixtoolset/wix3/releases/download/wix3112rtm/wix311-binaries.zip -O /tmp/wix.zip
    - mkdir -p /opt/wix
    - unzip /tmp/wix.zip -d /opt/wix
    - export PATH="$PATH:/opt/wix"
    - node --version
    - yarn --version
    - export DEBUG=electron-builder
    - export ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true
    - yarn install
    - yarn build$BUILD_MODE_SUFFIX
    - yarn electron-builder --win --x64 > build.log 2>&1 || (tail -1000 build.log && exit 1)
    - echo "Build completed successfully"
    - echo "Checking dist folder..."
    - ls -lh dist/ || echo "dist not found"
    - find dist -type f -name "*.exe" -exec ls -lh {} \;
  artifacts:
    name: "windows-builds-${CI_COMMIT_REF_SLUG}"
    expire_in: 1 week
    paths:
      - dist/*.exe
      - dist/*.blockmap
    when: on_success
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  tags:
    - docker

# Windows - Development (develop branch)
build-windows:dev:
  <<: *build-windows-template
  variables:
    NODE_ENV: development
    BUILD_MODE_SUFFIX: ":dev"
  only:
    - develop

# Windows - Staging (pre branch)
build-windows:staging:
  <<: *build-windows-template
  variables:
    NODE_ENV: staging
    BUILD_MODE_SUFFIX: ":staging"
  only:
    - pre

# Windows - Production (prod branch)
build-windows:prod:
  <<: *build-windows-template
  variables:
    NODE_ENV: production
    BUILD_MODE_SUFFIX: ""
  only:
    - prod

# ============================================================================
# LINUX BUILD STAGE
# ============================================================================

# Linux build template
.build-linux-template: &build-linux-template
  stage: Build-Linux
  image: electronuserland/builder
  timeout: 3h
  script:
    - corepack enable
    - corepack prepare yarn@4.11.0 --activate
    - apt-get update && apt-get install -y rpm build-essential libxtst-dev libpng++-dev gcc g++ make libpixman-1-dev libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
    - node --version
    - yarn --version
    - export DEBUG=electron-builder
    - export ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true
    - yarn install
    - yarn build$BUILD_MODE_SUFFIX
    - yarn electron-builder --x64 --linux deb > build.log 2>&1 || (tail -1000 build.log && exit 1)
    - echo "Build completed successfully"
    - echo "Checking dist folder..."
    - ls -lh dist || echo "dist not found"
  artifacts:
    name: "ubuntu-linux-builds-${CI_COMMIT_REF_SLUG}"
    expire_in: 1 week
    paths:
      - dist/*.deb
    when: on_success
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  tags:
    - docker

# Linux - Development (develop branch)
build-ubuntu-linux:dev:
  <<: *build-linux-template
  variables:
    NODE_ENV: development
    BUILD_MODE_SUFFIX: ":dev"
  only:
    - develop

# Linux - Staging (pre branch)
build-ubuntu-linux:staging:
  <<: *build-linux-template
  variables:
    NODE_ENV: staging
    BUILD_MODE_SUFFIX: ":staging"
  only:
    - pre

# Linux - Production (prod branch)
build-ubuntu-linux:prod:
  <<: *build-linux-template
  variables:
    NODE_ENV: production
    BUILD_MODE_SUFFIX: ""
  only:
    - prod

# ============================================================================
# macOS BUILD STAGE (commented out - requires macOS runner)
# ============================================================================
# build-macos:dev:
#   stage: Build-macOS
#   timeout: 4h
#   variables:
#     NODE_ENV: development
#   script:
#     - brew install node
#     - corepack enable
#     - corepack prepare yarn@4.11.0 --activate
#     - yarn install
#     - yarn build:dev
#     - yarn electron-builder --mac --x64
#     - yarn electron-builder --mac --arm64
#     - echo "Checking dist folder..."
#     - ls -lh dist || echo "dist not found"
#   artifacts:
#     name: "macos-builds-${CI_COMMIT_REF_SLUG}"
#     expire_in: 2 weeks
#     paths:
#       - dist/*.pkg
#     when: on_success
#   only:
#     - develop
#   tags:
#     - shared-macos-amd64

# build-macos:staging:
#   stage: Build-macOS
#   timeout: 4h
#   variables:
#     NODE_ENV: staging
#   script:
#     - brew install node
#     - corepack enable
#     - corepack prepare yarn@4.11.0 --activate
#     - yarn install
#     - yarn build:staging
#     - yarn electron-builder --mac --x64
#     - yarn electron-builder --mac --arm64
#     - echo "Checking dist folder..."
#     - ls -lh dist || echo "dist not found"
#   artifacts:
#     name: "macos-builds-${CI_COMMIT_REF_SLUG}"
#     expire_in: 2 weeks
#     paths:
#       - dist/*.pkg
#     when: on_success
#   only:
#     - pre
#   tags:
#     - shared-macos-amd64

# build-macos:prod:
#   stage: Build-macOS
#   timeout: 4h
#   variables:
#     NODE_ENV: production
#   script:
#     - brew install node
#     - corepack enable
#     - corepack prepare yarn@4.11.0 --activate
#     - yarn install
#     - yarn build
#     - yarn electron-builder --mac --x64
#     - yarn electron-builder --mac --arm64
#     - echo "Checking dist folder..."
#     - ls -lh dist || echo "dist not found"
#   artifacts:
#     name: "macos-builds-${CI_COMMIT_REF_SLUG}"
#     expire_in: 2 weeks
#     paths:
#       - dist/*.pkg
#     when: on_success
#   only:
#     - prod
#   tags:
#     - shared-macos-amd64
