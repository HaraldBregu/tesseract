#!/bin/bash
# Criterion PKG Pre-installation Script
# This script runs BEFORE the installation begins

# Get the actual user (not root when running as installer)
if [ -n "$USER" ] && [ "$USER" != "root" ]; then
    ACTUAL_USER="$USER"
elif [ -n "$SUDO_USER" ]; then
    ACTUAL_USER="$SUDO_USER"
else
    ACTUAL_USER=$(stat -f "%Su" /dev/console)
fi

ACTUAL_HOME=$(dscl . -read /Users/"$ACTUAL_USER" NFSHomeDirectory | awk '{print $2}')

# Log file for debugging
LOG_FILE="/tmp/criterion-install.log"
echo "=== Criterion Pre-installation started at $(date) ===" >> "$LOG_FILE"
echo "Running as user: $ACTUAL_USER, home: $ACTUAL_HOME" >> "$LOG_FILE"

# Check if Criterion is running and ask to close it
if pgrep -x "Criterion" > /dev/null; then
    echo "Criterion is running, attempting to close..." >> "$LOG_FILE"
    # Try graceful close first
    sudo -u "$ACTUAL_USER" osascript -e 'tell application "Criterion" to quit' 2>/dev/null
    sleep 2
    
    # If still running, force close
    if pgrep -x "Criterion" > /dev/null; then
        echo "Force closing Criterion..." >> "$LOG_FILE"
        pkill -9 "Criterion" 2>/dev/null
        sleep 1
    fi
fi

# Backup user templates if they exist (for upgrades)
USER_DATA_DIR="$ACTUAL_HOME/Library/Application Support/Criterion"
USER_TEMPLATES_DIR="$USER_DATA_DIR/templates"
USER_STYLES_DIR="$USER_DATA_DIR/styles"
BACKUP_DIR="$USER_DATA_DIR/backup-$(date +%Y%m%d%H%M%S)"

if [ -d "$USER_TEMPLATES_DIR" ]; then
    echo "Backing up user templates to $BACKUP_DIR" >> "$LOG_FILE"
    mkdir -p "$BACKUP_DIR/templates"
    cp -R "$USER_TEMPLATES_DIR"/* "$BACKUP_DIR/templates/" 2>/dev/null
    chown -R "$ACTUAL_USER" "$BACKUP_DIR" 2>/dev/null
fi

if [ -d "$USER_STYLES_DIR" ]; then
    echo "Backing up user styles to $BACKUP_DIR" >> "$LOG_FILE"
    mkdir -p "$BACKUP_DIR/styles"
    cp -R "$USER_STYLES_DIR"/* "$BACKUP_DIR/styles/" 2>/dev/null
    chown -R "$ACTUAL_USER" "$BACKUP_DIR" 2>/dev/null
fi

echo "Pre-installation completed successfully" >> "$LOG_FILE"
exit 0
