#!/bin/bash
# Criterion PKG Post-installation Script
# This script runs AFTER the installation completes

# Get the actual user (not root when running as installer)
if [ -n "$USER" ] && [ "$USER" != "root" ]; then
    ACTUAL_USER="$USER"
elif [ -n "$SUDO_USER" ]; then
    ACTUAL_USER="$SUDO_USER"
else
    ACTUAL_USER=$(stat -f "%Su" /dev/console)
fi

ACTUAL_HOME=$(dscl . -read /Users/"$ACTUAL_USER" NFSHomeDirectory | awk '{print $2}')

# Log file for debugging
LOG_FILE="/tmp/criterion-install.log"
echo "=== Criterion Post-installation started at $(date) ===" >> "$LOG_FILE"
echo "Running as user: $ACTUAL_USER, home: $ACTUAL_HOME" >> "$LOG_FILE"

# Application paths
APP_PATH="/Applications/Criterion.app"
RESOURCES_PATH="$APP_PATH/Contents/Resources"

# User data directories
USER_DATA_DIR="$ACTUAL_HOME/Library/Application Support/Criterion"
USER_CONFIG_DIR="$USER_DATA_DIR/config-store"
USER_TEMPLATES_DIR="$USER_DATA_DIR/templates"
USER_STYLES_DIR="$USER_DATA_DIR/styles"

# Create necessary directories
echo "Creating user directories..." >> "$LOG_FILE"
mkdir -p "$USER_CONFIG_DIR"
mkdir -p "$USER_TEMPLATES_DIR"
mkdir -p "$USER_STYLES_DIR"

# Set proper ownership and permissions
chown -R "$ACTUAL_USER" "$USER_DATA_DIR"
chmod -R 755 "$USER_DATA_DIR"

# Restore user templates from backup if available
LATEST_BACKUP=$(ls -dt "$USER_DATA_DIR"/backup-* 2>/dev/null | head -1)
if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
    echo "Restoring user files from backup: $LATEST_BACKUP" >> "$LOG_FILE"
    
    if [ -d "$LATEST_BACKUP/templates" ]; then
        cp -Rn "$LATEST_BACKUP/templates"/* "$USER_TEMPLATES_DIR/" 2>/dev/null
    fi
    
    if [ -d "$LATEST_BACKUP/styles" ]; then
        cp -Rn "$LATEST_BACKUP/styles"/* "$USER_STYLES_DIR/" 2>/dev/null
    fi
    
    echo "Backup restored, cleaning up old backups..." >> "$LOG_FILE"
    # Keep only the 3 most recent backups
    ls -dt "$USER_DATA_DIR"/backup-* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null
fi

# Copy default templates if user templates directory is empty
if [ -d "$RESOURCES_PATH/buildResources/templates" ]; then
    if [ ! "$(ls -A "$USER_TEMPLATES_DIR" 2>/dev/null)" ]; then
        echo "Copying default templates..." >> "$LOG_FILE"
        cp -R "$RESOURCES_PATH/buildResources/templates"/* "$USER_TEMPLATES_DIR/" 2>/dev/null
    fi
fi

# Copy default styles if user styles directory is empty
if [ -d "$RESOURCES_PATH/buildResources/styles" ]; then
    if [ ! "$(ls -A "$USER_STYLES_DIR" 2>/dev/null)" ]; then
        echo "Copying default styles..." >> "$LOG_FILE"
        cp -R "$RESOURCES_PATH/buildResources/styles"/* "$USER_STYLES_DIR/" 2>/dev/null
    fi
fi

# Fix ownership of copied files
chown -R "$ACTUAL_USER" "$USER_DATA_DIR"

# Register file associations
echo "Registering file associations..." >> "$LOG_FILE"
/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f "$APP_PATH" 2>/dev/null

echo "Post-installation completed successfully" >> "$LOG_FILE"
echo "=== Installation log: $LOG_FILE ===" >> "$LOG_FILE"

exit 0
