openapi: 3.1.0
info:
  title: User API
  description: API definition of Criterion User Microservice
  version: 1.0.0

servers:
  - url: http://localhost:8080/api/v1

tags:
  - name: User Management
    description: APIs for user registration, authentication, and profile management

paths:
  /user/{userId}/update:
    put:
      tags:
        - User Management
      summary: Update user profile
      description: Updates user profile information
      operationId: updateUser
      parameters:
        - name: userId
          in: path
          description: User ID
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserDto'
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedModel'
        '400':
          description: Invalid input data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OutputUserDto'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OutputUserDto'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OutputUserDto'
      security:
        - basicAuth: []

  /user/search:
    post:
      tags:
        - User Management
      summary: Search users
      description: Retrieves a list of users paged
      operationId: searchUsers
      parameters:
        - name: page
          in: query
          description: Page number
          required: false
          schema:
            type: integer
            format: int32
            default: 0
          example: 0
        - name: size
          in: query
          description: Page size
          required: false
          schema:
            type: integer
            format: int32
            default: 20
          example: 20
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InputSearchDto'
      responses:
        '200':
          description: Users found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedModelOutputUserDto'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedModelOutputUserDto'
      security:
        - basicAuth: []

  /user/register:
    post:
      tags:
        - User Management
      summary: Register a new user
      description: Creates a new user account
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InputUserDto'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OutputUserDto'
        '400':
          description: Invalid input data
        '409':
          description: Email already exists

  /user/id/{userId}:
    get:
      tags:
        - User Management
      summary: Get user by ID
      description: Retrieves user information by user ID
      operationId: getUserById
      parameters:
        - name: userId
          in: path
          description: User ID
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OutputUserDto'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OutputUserDto'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OutputUserDto'
      security:
        - basicAuth: []

  /user/email/{email}:
    get:
      tags:
        - User Management
      summary: Get user by email
      description: Retrieve an user by email
      operationId: getUserByEmail
      parameters:
        - name: email
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OutputUserDto'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OutputUserDto'
      security:
        - basicAuth: []

  /user/{userId}:
    delete:
      tags:
        - User Management
      summary: Delete user
      description: Deletes a user account
      operationId: deleteUser
      parameters:
        - name: userId
          in: path
          description: User ID
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: User deleted successfully
        '401':
          description: Not authenticated
        '404':
          description: User not found
      security:
        - basicAuth: []

  /password/forgot-password/request:
    post:
      tags:
        - User Management
      summary: Request new code
      description: Request new code to generate new password
      operationId: requestCode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: string
      responses:
        '200':
          description: Code sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponseDto'
        '400':
          description: Invalid email or user not found
        '404':
          description: User not found

  /password/forgot-password/change:
    post:
      tags:
        - User Management
      summary: Change forgotten password
      description: Changes the password after successful code validation
      operationId: changeForgottenPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordDto'
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponseDto'
        '400':
          description: Invalid input data or expired code
        '401':
          description: Unauthorized - invalid or expired reset code
        '404':
          description: User not found

  /password/change:
    post:
      tags:
        - User Management
      summary: Change password
      description: Changes the password for an authenticated user
      operationId: changePassword
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordDto'
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponseDto'
        '400':
          description: Invalid input data
        '401':
          description: Unauthorized - invalid credentials or old password incorrect

  /password/auth:
    post:
      tags:
        - User Management
      summary: Validate authorization
      description: Validates Basic Authentication credentials
      operationId: authorization
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Authorization validated successfully
          content:
            application/json:
              schema:
                type: boolean
        '401':
          description: Unauthorized - invalid credentials

components:
  schemas:
    UpdateUserDto:
      type: object
      description: DTO for updating user profile information
      required:
        - userName
        - userSurname
      properties:
        userName:
          type: string
          description: Name of the user
          example: Alfonso
          minLength: 0
          maxLength: 50
          pattern: "^[A-Za-zÀ-ÖØ-öø-ÿ\\s'-]+$"
        userSurname:
          type: string
          description: Surname of the user
          example: Neri
          minLength: 0
          maxLength: 50
          pattern: "^[A-Za-zÀ-ÖØ-öø-ÿ\\s'-]+$"
        userInstitution:
          type: string
          description: Institution of the user (optional)
          example: University of Rome
          minLength: 0
          maxLength: 150
        userKeywords:
          type: array
          description: Keywords related to user interests (optional). Keywords are automatically converted to lowercase. Max 8 keywords, each between 1-40 characters.
          example:
            - ai
            - java
            - postgresql
          minItems: 0
          maxItems: 8
          uniqueItems: true
          items:
            type: string
            minLength: 1
            maxLength: 40

    InputUserDto:
      type: object
      description: DTO representing a User registration request
      required:
        - userName
        - userSurname
        - userEmail
        - password
        - confirmPassword
        - policyAccepted
      properties:
        userName:
          type: string
          description: Name of the user
          example: Alfonso
          minLength: 0
          maxLength: 50
          pattern: "^[A-Za-zÀ-ÖØ-öø-ÿ\\s'-]+$"
        userSurname:
          type: string
          description: Surname of the user
          example: Neri
          minLength: 0
          maxLength: 50
          pattern: "^[A-Za-zÀ-ÖØ-öø-ÿ\\s'-]+$"
        userInstitution:
          type: string
          description: Institution of the user (optional)
          example: University of Rome
          minLength: 0
          maxLength: 150
        userKeywords:
          type: array
          description: Keywords related to user interests (optional). Keywords are automatically converted to lowercase. Max 8 keywords, each between 1-40 characters.
          example:
            - ai
            - java
            - postgresql
          minItems: 0
          maxItems: 8
          uniqueItems: true
          items:
            type: string
            minLength: 1
            maxLength: 40
        userEmail:
          type: string
          format: email
          description: Email address of the user
          example: alfonso.neri@example.com
          minLength: 0
          maxLength: 100
          pattern: "^[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}$"
        password:
          type: string
          description: Password for the user account
          example: SecureP@ssw0rd!
          minLength: 8
          maxLength: 255
          pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[^A-Za-z\\d])[A-Za-z\\d\\W]{8,255}$"
        confirmPassword:
          type: string
          description: Password confirmation
          example: SecureP@ssw0rd!
          minLength: 8
          maxLength: 255
          pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[^A-Za-z\\d])[A-Za-z\\d\\W]{8,255}$"
        policyAccepted:
          type: boolean
          description: User must accept the privacy policy
          example: true
        passwordMatching:
          type: boolean

    OutputUserDto:
      type: object
      description: DTO representing a User returned by the API
      properties:
        userId:
          type: string
          format: uuid
          description: Unique identifier of the user
          example: 550e8400-e29b-41d4-a716-446655440000
        userEmail:
          type: string
          description: Email address of the user
          example: alfonso.neri@example.com
        userName:
          type: string
          description: First name of the user
          example: Alfonso
        userSurname:
          type: string
          description: Last name of the user
          example: Neri
        userInstitution:
          type: string
          description: Institution of the user
          example: University of Rome
        userKeywords:
          type: array
          description: Keywords related to user interests
          example:
            - ai
            - java
            - postgresql
          uniqueItems: true
          items:
            type: string
        status:
          type: string
          description: Current status of the user account
          enum:
            - Active
            - Reset
            - Inactive
          example: Active
        creationDate:
          type: string
          format: date-time
          description: Date when the user was created
          example: "2025-11-19T10:30:00"
        lastUpdateDate:
          type: string
          format: date-time
          description: Date when the user information was last updated
          example: "2025-11-19T14:30:00"
        lastAccessDate:
          type: string
          format: date-time
          description: Date of the last successful login
          example: "2025-11-19T14:30:00"
        policyAcceptedDate:
          type: string
          format: date-time
          description: Date when the user accepted the privacy policy
          example: "2025-11-19T10:30:00"

    InputSearchDto:
      type: object
      description: Search request DTO
      properties:
        textToSearch:
          type: string
          description: Text to be used for the search
          example: antonio
        fields:
          type: array
          description: Fields to search in
          example:
            - userName
            - userSurname
            - userKeywords
            - userEmail
          uniqueItems: true
          items:
            type: string

    PageMetadata:
      type: object
      properties:
        size:
          type: integer
          format: int64
        number:
          type: integer
          format: int64
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer
          format: int64

    PagedModel:
      type: object
      properties:
        content:
          type: array
          items: {}
        page:
          $ref: '#/components/schemas/PageMetadata'

    PagedModelOutputUserDto:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/OutputUserDto'
        page:
          $ref: '#/components/schemas/PageMetadata'

    MessageResponseDto:
      type: object
      description: Generic message response
      properties:
        message:
          type: string
          description: Response message
          example: Operation completed successfully
        success:
          type: boolean
          description: Success flag
          example: true
        messageTimestamp:
          type: string
          format: date-time
          description: Timestamp when the message was created

    ResetPasswordDto:
      type: object
      description: DTO for resetting forgotten password
      required:
        - email
        - resetCode
        - newPassword
      properties:
        email:
          type: string
          format: email
          description: Email address of the user
          example: alfonso.neri@example.com
          minLength: 0
          maxLength: 100
        resetCode:
          type: string
          description: Reset code received and validated via email
          example: "123456"
          minLength: 6
          maxLength: 6
        newPassword:
          type: string
          description: New password
          example: NewP@ssw0rd!
          minLength: 8
          maxLength: 100
          pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[^A-Za-z\\d])[A-Za-z\\d\\W]{8,100}$"

    ChangePasswordDto:
      type: object
      description: DTO for changing password
      required:
        - oldPassword
        - newPassword
      properties:
        oldPassword:
          type: string
          description: Current password
          example: OldP@ssw0rd!
          minLength: 8
          maxLength: 100
          pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[^A-Za-z\\d])[A-Za-z\\d\\W]{8,100}$"
        newPassword:
          type: string
          description: New password
          example: NewP@ssw0rd!
          minLength: 8
          maxLength: 100
          pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[^A-Za-z\\d])[A-Za-z\\d\\W]{8,100}$"

  securitySchemes:
    basicAuth:
      type: http
      description: Basic Authentication
      scheme: basic
